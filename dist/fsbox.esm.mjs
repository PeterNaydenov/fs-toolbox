import e from"fs";import r from"ask-for-promise";const t={"wrong argument numbers":"Error: Wrong numbers or type of arguments. Please, check the documentation.","wrong by":'Error: Option "by" is not defined or not correct. Please, check the documentation.',"no selection":"Error: No selection specified. Provide reduce criteria.","wrong deep level":"Error: Deep level is an array and size is different from folder array.","cache.files empty":'Error: File cache is empty. Please, fulfil files cache by using "set" or "scan" methods.',"cache.write empty":"Error: Cache.write is empty.","not empty":"Error: Folder is not empty: "};let s={},l=[],i=0,o={prefix:"-",suffix:"-"};s.folders=[],s.files=[],s.read=[],s.write=[];var a={model:function(){return{error:!1,errorList:[],list:[],set:{}}},scanner:function(){return{error:!1,errorList:[],list:[],set:{},scannedFolders:[],foldersDeep:[],deep:1e4,ignore_subfolders:[]}},scanFiles:function(){let e=a.scanner();e.afterWalk=a._triggerCallbacks,e.set=a._argSetup.apply(this,arguments),a._scanSetup.call(e),e.error?a._walkFiles.call(e,[],[]):a._walkFiles.call(e,e.set.list,e.foldersDeep)},scanFolders:function(){let e=a.scanner();e.afterWalk=a._triggerCallbacks,e.set=a._argSetup.apply(this,arguments),a._scanSetup.call(e),e.error?a._walkFolders.call(e,[],[]):a._walkFolders.call(e,e.set.list,e.foldersDeep)},get:function(e){var r;switch(e){case"file":case"files":r=JSON.stringify(s.files);break;case"folder":case"folders":r=JSON.stringify(s.folders);break;case"read":r=JSON.stringify(s.read);break;case"write":r=JSON.stringify(s.write);break;case"del":case"delimiters":r=JSON.stringify(o);break;default:return!1}return JSON.parse(r)},set:function(e,r){var t,l,i=!1;if(arguments.length<2)return!1;if(null==r)return!1;switch(r instanceof Array&&(l="array"),"string"==typeof r&&(l="string"),l){case"array":(r=JSON.parse(JSON.stringify(r))).every((e=>"string"==typeof e))||(i=!0);break;case"string":r=[r];break;default:r.prefix||(i=!0),r.suffix||(i=!0),r=JSON.parse(JSON.stringify(r))}if(i)return!1;switch(t=r,e){case"file":case"files":return s.files=t,!0;case"folder":case"folders":return s.folders=t,!0;case"del":case"delimiters":return o=t,!0;default:return!1}},resetCache:function(e){e?s[e]=[]:(s.files=[],s.folders=[],s.read=[],s.write=[],i=0),"write"==e&&(i=0)},specifyCache:function(e){s[e]=s.files,s.files=[],"write"==e&&(l=a.get("write"),i=l.length)},_argSetup:function(){var e,r,t,s=arguments,l=Array.prototype;return e=l.pop.call(s),r=s.length>0?l.shift.call(s):[],t=s.length>0?l.pop.call(s):{},Buffer.isBuffer(r)&&(r=[r]),"string"==typeof r&&(r=[r]),"function"==typeof e&&(e=[e]),{list:r,options:t,callbackList:e}},_scanSetup:function(){var e=this.set;this.ignore_subfolders=!!e.options.hasOwnProperty("ignore")&&e.options.ignore,this.deep=e.options.hasOwnProperty("deep")?e.options.deep:this.deep,this.foldersDeep=this.deep instanceof Array?e.list.map(((e,r)=>e.split("/").length+this.deep[r])):e.list.map((e=>e.split("/").length+this.deep)),this.foldersDeep.every((e=>0==isNaN(e)))||(this.error=!0,this.errorList.push(t["wrong deep level"]))},_triggerCallbacks:function(e){var r=this.error;r&&(r=this.errorList),this.set.callbackList.forEach((t=>t(r,s[e])))},_walkFiles:function(r,t){var s,l,i,o=this;if(import("path").then((e=>i=e)),0==r.length)return a.set("files",o.list),o.afterWalk("files");if(s=r.shift(),l=t.shift(),!o.scannedFolders.every((e=>e!=s)))return a._walkFiles.call(o,r,t);o.scannedFolders.push(s),e.readdir(s,((n,p)=>{n&&(o.error=!0,o.errorList.push("No such folder as ["+s+"]")),o.error||p.reduce(((a,n)=>{let p=s+i.sep+n;if(e.lstatSync(p).isDirectory()){let e=!0;if(p.split("/").length-1>=l&&(e=!1),e&&o.ignore_subfolders){o.ignore_subfolders.every((e=>e!=n))||(e=!1)}if(e){o.scannedFolders.every((e=>e!=p))&&(r.push(p),t.push(l))}}else{"."!=n.slice(0,1)&&(a.push(p),o.list.push(p))}return a}),[]),a._walkFiles.call(o,r,t)}))},_walkFolders:function(r,t){var s,l,i,o=this;if(import("path").then((e=>i=e)),0==r.length)return a.set("folders",o.list),void o.afterWalk("folders");s=r.shift(),l=t.shift(),o.scannedFolders.every((e=>e!=s))?(o.scannedFolders.push(s),e.readdir(s,((n,p)=>{n&&(o.error=!0,o.errorList.push("No such folder as ["+s+"]")),o.error||p.reduce(((a,n)=>{let p=s+i.sep+n;if(e.lstatSync(p).isDirectory()){let e=!0;if(o.ignore_subfolders){o.ignore_subfolders.every((e=>e!=n))||(e=!1)}if(e){a.push(p),o.list.push(p),p.split("/").length-1>=l&&(e=!1)}if(e){o.scannedFolders.every((e=>e!=p))&&(r.push(p),t.push(l))}}return a}),[]),a._walkFolders.call(o,r,t)}))):a._walkFolders.call(o,r,t)},encode:function(e){return"object"==typeof e?Buffer.from(JSON.stringify(e,null,4),"utf8"):Buffer.from(e,"utf8")},decode:function(e){return Buffer.from(e,"binary").toString("utf8")},readFile:function(r){var s,l=a.model();if(0==(s=this.get("read")).length&&(s=this.get("files")),0==s.length)return l.error=!0,l.errorList.push(t["cache.files empty"]),!1;if(!r){let r=[];return r.length=s.length,s.forEach(((t,s)=>{try{r[s]=e.readFileSync(t,encode)}catch(e){r[s]=!1}})),r}s.forEach(((t,s)=>{e.readFile(t,((e,t)=>{r(!e&&t,s)}))}))},writeFile:function(){var r=a.model(),s=null,o=a._triggerCallbacks;if(r.set=a._argSetup.apply(this,arguments),r.set.options.hasOwnProperty("number")&&(s=r.set.options.number),0==l.length)return r.error=!0,r.errorList.push(t["cache.write is empty"]),o.call(r,"write");if(null!=s){if(void 0===l[s])return r.error=!0,r.errorList.push(t["cache.write is empty"]),p();{let e=l[s].split("/");e.pop(),n(e,s,r.set.list[0]||"")}}else l.forEach(((e,t)=>{if(!1===e)return i--,void(0==i&&p());{let s=e.split("/");s.pop(),n(s,t,r.set.list[t]||"")}}));function n(r,t,s){a.mkdir(r.join("/"),((r,o)=>{Buffer.isBuffer(s)||(s=Buffer.from(s,"binary")),e.writeFile(l[t],s,((e,r)=>{i--,0==i&&p()}))}))}function p(){o.call(r,"write"),l=[],a.resetCache("write")}},mkdir:function(){var e=a.model();e.set=a._argSetup.apply(this,arguments),e.afterMake=a._triggerCallbacks,e.list=a._arrangeAllPaths(e.set.list),a._mk.call(e,e.list)},_mk:function(r){var t;0!=r.length?(t=r.shift(),e.stat(t,((s,l)=>{l?a._mk.call(this,r):e.mkdir(t,(()=>a._mk.call(this,r)))}))):this.set.callbackList.forEach((e=>e(!1,!0)))},_arrangeAllPaths:function(e){var r=[];return e.forEach((e=>{let t=e.split("/").reduce(((e,r,t)=>{var s;return s=t>0?e[t-1]+"/"+r:r,e.push(s),e}),[]);r=r.concat(t)})),r.reduce(((e,r)=>(e.every((e=>e!=r))&&e.push(r),e)),[])},keep:function(){var e,r,l=a.model(),i=!1,o=a._triggerCallbacks;switch(l.set=a._argSetup.apply(this,arguments),e=l.set.options.by,r=l.set.list,3!=arguments.length&&(l.error=!0,l.errorList.push(t["wrong argument numbers"])),0==r.length&&(l.error=!0,l.errorList.push(t["no selection"])),e){case"ext":case"extension":i="ext";break;case"key":case"keys":case"prefix":i="prefix";break;case"filename":i="filename";break;case"name":i="name";break;case"suffix":i="suffix";break;case"path":i="path"}i||(l.errorList.push(t["wrong by"]),l.error=!0),l.error||(l.list=s.files.reduce(((e,t)=>{let s=a._find[i](t);return r.every((e=>s!=e))||e.push(t),e}),[]),a.set("files",l.list)),o.call(l,"files")},_find:{ext:e=>e.split("/").pop().split(".").pop(),prefix:e=>e.split("/").pop().split(".").shift().split(o.prefix).shift(),suffix:e=>e.split("/").pop().split(".").shift().split(o.suffix).pop(),name:e=>e.split("/").pop().split(".").shift(),filename:e=>e.split("/").pop(),path:e=>e},keepFolders:function(){var e,r,t=s.folders,l=a.model(),i=a._triggerCallbacks;l.set=a._argSetup.apply(this,arguments),r=l.set.options,e=r.hasOwnProperty("deep")?r.deep:9999,l.list=t.reduce(((r,t)=>{let s=t.split("/"),i=s.length;return s.forEach(((s,o)=>{let a=!1;if(!l.set.list.every((e=>e!=s))){o+1+e>=i&&(a=!0)}a&&r.push(t)})),r}),[]),a.set("folders",l.list),i.call(l,"folders")},keepFoldersInSteps:function(){var e,r=a.model(),s=a._triggerCallbacks,l=!1;if(r.set=a._argSetup.apply(this,arguments),(e=r.set.options).hasOwnProperty("deep")){(l="number"==typeof e.deep?r.set.list.map((()=>e.deep)):r.set.list.map(((r,t)=>e.deep[t]))).every((e=>null!=e))||(r.error=!0,r.errorList.push(t["wrong deep level"]))}r.error||(l?r.set.list.forEach(((e,r)=>a.keepFolders([e],{deep:l[r]},(()=>{})))):r.set.list.forEach((e=>a.keepFolders([e],(()=>{}))))),s.call(r,"folders")},removeFiles:function(){var e,r,s=a.model(),l=a._triggerCallbacks;if(s.set=a._argSetup.apply(this,arguments),e=s.set.options.by||!1,0==Object.getOwnPropertyNames(s.set.options).length&&s.errorList.push(t["wrong argument numbers"]),e||s.errorList.push(t["wrong by"]),s.errorList.length>0)return s.error=!0,l.call(s,"files");r=s.set.list,s.list=a.get("files"),r.forEach((r=>{s.list=s.list.filter((t=>a._find[e](t)!=r))})),a.set("files",s.list),l.call(s,"files")},removeFolders:function(){var e=s.folders,r=a.model(),t=a._triggerCallbacks;r.set=a._argSetup.apply(this,arguments),r.list=e.reduce(((e,t)=>{let s=t.split("/"),l=!0,i=!1;return s.forEach(((e,t)=>{if(i)return;r.set.list.every((r=>r!=e))||(l=!1,i=!0)})),l&&e.push(t),e}),[]),a.set("folders",r.list),t.call(r,"folders")},deleteFiles:function(){var e,t=a.model(),s=a._triggerCallbacks;t.set=a._argSetup.apply(this,arguments),0==(e=a.get("read")).length&&(e=a.get("files"));let l=r();a._deleteFiles.call(t,l.done,e),l.promise.then((()=>{a.set("files",[]),s.call(t,"files")}))},deleteFolders:function(){var e,t=a.model(),s=a._triggerCallbacks;t.set=a._argSetup.apply(this,arguments),e=a.get("folders");let l=r();a._deleteFolders.call(t,l.done,e),l.promise.then((()=>{a.set("folders",t.list),s.call(t,"folders")}))},empty:function(){var e,t=a.model(),s=a._triggerCallbacks,l=a._copy;t.set=a._argSetup.apply(this,arguments),e=l(t.set.list);let i=r();a._empty.call(t,i.done,e),i.promise.then((()=>{a.set("files",[]),s.call(t,"files")}))},emptyFolders:function(){var e=a.model(),t=a._triggerCallbacks,s=a._copy;e.set=a._argSetup.apply(this,arguments);let l=a._sort(s(e.set.list)),i=r(),o=r();a._empty.call(e,i.done,s(l)),i.promise.then((()=>(a._emptyFolders.call(e,o.done,l),o.promise))).then((()=>{a.resetCache.call(e),t.call(e,"folders")}))},_empty:function(e,t){var s,l=this;if(0==t.length)return e();s=t.shift(),a.scanFiles(s,((i,o)=>{if(0==o.length)return a._empty.call(l,e,[]);let n=r();a._deleteFiles.call(l,n.done,o),n.promise.then((()=>{l.list.push(s),a._empty.call(l,e,t)}))}))},_emptyFolders:function(e,t){var s,l=this;if(0==t.length)return e();s=t.shift(),a.scanFolders(s,((i,o)=>{if(0==o.length)return a._emptyFolders.call(l,e,[]);let n=r();a._deleteFolders.call(l,n.done,o),n.promise.then((()=>{l.list.push(s),a._emptyFolders.call(l,e,t)}))}))},_deleteFiles:function(r,t){var s,l=this;if(0==t.length)return r();s=t.pop(),e.unlink(s,(()=>a._deleteFiles.call(l,r,t)))},_deleteFolders:function(r,s){var l,i=this;if(0==s.length)return r();l=s.pop(),e.rmdir(l,((e,o)=>{e&&(i.error=!0,i.errorList.push(t["not empty"]+l),i.list.push(l)),a._deleteFolders.call(i,r,s)}))},_sort:function(e){var r=0,t=1e3,s=[];if(e.length<=1)return e;let l=e.map((e=>e.split("/").length));l.forEach((e=>{e<t&&(t=e),e>r&&(r=e)}));let i=l.map((e=>e-t));r=r-t+1;let o=new Array(r),a=r;for(;a--;)o[a]=a;return o.forEach((r=>{i.forEach(((t,l)=>{t==r&&s.push(e[l])}))})),s},_copy:function(e){return JSON.parse(JSON.stringify(e))}},n={set:a.set,get:a.get,fileCacheAs:a.specifyCache,resetCache:a.resetCache,clearCache:a.resetCache,scan:a.scanFiles,scanFolder:a.scanFolders,scanFolders:a.scanFolders,keep:a.keep,keepFolder:a.keepFolders,keepFolders:a.keepFolders,keepFolderSteps:a.keepFoldersInSteps,keepFoldersSteps:a.keepFoldersInSteps,remove:a.removeFiles,removeFolder:a.removeFolders,removeFolders:a.removeFolders,delete:a.deleteFiles,deleteFolder:a.deleteFolders,deleteFolders:a.deleteFolders,empty:a.empty,emptyFolder:a.emptyFolders,emptyFolders:a.emptyFolders,read:a.readFile,write:a.writeFile,makeFolder:a.mkdir,decode:a.decode,encode:a.encode,sequence:["Compose sequence of library operations"],modifyPath:["Modify cache files paths. With replace?"],modifyPathFolders:["Modify cache folder paths"]};export{n as default};
